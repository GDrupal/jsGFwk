<html>
<head>
</head>
<script language="Javascript" src="../../Framework/jsGFwk.js"></script>
<script language="Javascript" src="../../Framework/jsGFwkRM.js"></script>
<script language="Javascript" src="../../Framework/jsGFwkIO.js"></script>
<body style="background-color:#CCCCCC;">
	<canvas id="canvas" width="320" height="240"></canvas>
</body>
<script language="Javascript">
	jsGFwk.settings.canvas = "canvas";
	jsGFwk.settings.clearColor = "rgb(0,0,0)";
	
	jsGFwk.include("resources");
	jsGFwk.include("IO");
	
	jsGFwk.resources.addSprite({ name: "sprites", source: "sprites.png" });
	jsGFwk.resources.addSound({ name: "spaceShipShoot", source: "shoot.wav" });
	
	jsGFwk.createObject({
		id: "progress",
		visible: true,
		barWidth: 0,
		init: function() {
			jsGFwk.resources.onResourcesLoadedCompleted = function() {
				buildGame();
				jsGFwk._gameObjects.progress.destroy();
			};
		},
		update: function(delta) {
			var a = (jsGFwk.resources._totalLoadedResources * 100) / jsGFwk.resources._totalResources;
			this.barWidth = (a * 320) / 100;
		},
		draw: function (context) {
			context.save();
				context.fillStyle = "#FF0000";
				context.fillRect(0,0, 320, 240);
				
				context.fillStyle = "#FFFFFF";
				context.fillText("Loading...", 140, 120);
				
				context.strokeStyle = "#FFFFFF";
				context.strokeRect(10, 140, 300, 10);
				context.fillRect(10, 140, this.barWidth, 10);
			context.restore();
		}
	});
	
	jsGFwk.start();
	
	function buildGame() {
		jsGFwk.createObject({
			id: "starBackground",
			zOrder: 0,
			offset: 0,
			starImage: {},
			init: function () {	
				var c = document.createElement("canvas");
				c.width = 320;
				c.height = 240;
				var ctx = c.getContext("2d");
				ctx.beginPath();
				ctx.fillStyle="black";
				ctx.rect(0,0,320,240);
				ctx.fill();
				ctx.beginPath();
				for (var n=0; n < 100; n++){
					var x=parseInt(Math.random() * canvas.width);
					var y=parseInt(Math.random() * canvas.height);
					var radius=Math.random() * 1;
					ctx.arc(x, y, radius, 0, Math.PI * 2, false);
					ctx.closePath();
				}
				ctx.fillStyle="white";
				ctx.fill();

				this.starImage = new Image();
				this.starImage.src = c.toDataURL();
			},
			visible: true,
			update: function(delta) {
				this.offset-=1;
				if(this.offset < 0){ this.offset = 240; }
			},
			draw: function (context) {
				context.drawImage(this.starImage,0, -this.offset);
				context.drawImage(this.starImage,0, 240 - this.offset);
			}
		});
	
		jsGFwk.createObject({
			id: "spaceShip",
			x: 150,
			y: 200,
			shipSpeed: 1.5,
			bulletSpeed: 2.5,
			bulletShootDelay: 0.7,
			delayCounter: 0,
			bullets: [],
			zOrder: 1,
			init: function () {	},
			visible: true,
			update: function(delta) {
				this.delayCounter+=delta;
				
				if (jsGFwk.IO.keyboard._activeKey[39]) { this.x+=this.shipSpeed; }
				if (jsGFwk.IO.keyboard._activeKey[37]) { this.x-=this.shipSpeed; }
				if (jsGFwk.IO.keyboard._activeKey[32]) { 
					if (this.bullets.length < 3 && this.delayCounter >= this.bulletShootDelay || this.bullets.length == 0) {
						this.delayCounter = 0;
						this.bullets.push({x: this.x + 7, y: this.y - 8});
						jsGFwk.resources.sounds.spaceShipShoot.audio.play();
					}
				}
				
				for (var i = 0; i < this.bullets.length;) {
					this.bullets[i].y -= this.bulletSpeed;
					if (this.bullets[i].y < -10) { 
						this.bullets.splice(i, 1); 
					} else { i++; }
				}
			},
			draw: function (context) {
				context.drawImage(jsGFwk.resources.sprites.sprites.image,
					169, 19, 15, 16, this.x, this.y, 15, 16);
				
				for (var bullet in this.bullets) {
					context.drawImage(jsGFwk.resources.sprites.sprites.image,
						351, 159, 3, 8,	this.bullets[bullet].x, this.bullets[bullet].y, 3, 8);
				}
			}
		});
		
		jsGFwk.createObject({
			id: "formation",
			formation: [],
			init: function () {	
				this.formation[0] = [1,1,1,1,1,1];
				this.formation[1] = [2,2,2,2,2,2];
				this.formation[2] = [3,3,3,3,3,3];
			},
			visible: true,
			update: function(delta) {
				this.delayCounter+=delta;
			},
			draw: function (context) {
				
			}
		});
	}
</script>
</html>